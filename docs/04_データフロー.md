# データフロー設計

## 1. 初回起動フロー

### 1.1 シーケンス図

```
┌──────┐      ┌─────────────┐      ┌──────────┐      ┌──────────┐
│ User │      │   chat.py   │      │ RAGEngine│      │ChromaDB  │
└──┬───┘      └──────┬──────┘      └────┬─────┘      └────┬─────┘
   │                 │                   │                 │
   │ python chat.py  │                   │                 │
   │────────────────>│                   │                 │
   │                 │                   │                 │
   │                 │ RAGEngine.__init__()                │
   │                 │──────────────────>│                 │
   │                 │                   │ コレクション確認│
   │                 │                   │────────────────>│
   │                 │                   │<────────────────│
   │                 │                   │ count = 0       │
   │                 │                   │                 │
   │                 │ init_from_files() │                 │
   │                 │──────────────────>│                 │
   │                 │                   │                 │
   │                 │                   │ knowledge/読込  │
   │                 │                   │──┐              │
   │                 │                   │  │ テキスト     │
   │                 │                   │<─┘ 分割         │
   │                 │                   │                 │
   │                 │                   │ embed()         │
   │                 │                   │──┐ (各チャンク) │
   │                 │                   │  │ 埋め込み生成 │
   │                 │                   │<─┘              │
   │                 │                   │                 │
   │                 │                   │ add()           │
   │                 │                   │────────────────>│
   │                 │                   │                 │ 保存
   │                 │                   │<────────────────│
   │                 │<──────────────────│ 完了            │
   │                 │                   │                 │
   │<────────────────│ 準備完了          │                 │
   │  初回起動: 30秒 │                   │                 │
```

### 1.2 処理詳細

| ステップ | 処理 | 所要時間 | 備考 |
|---------|------|---------|------|
| 1 | config.yaml読み込み | <0.1秒 | - |
| 2 | OllamaClient初期化 | <0.1秒 | 接続確認なし |
| 3 | ChromaDB接続 | <0.5秒 | ディレクトリ作成 |
| 4 | 既存データ確認 | <0.1秒 | count() |
| 5 | knowledge/読み込み | <1秒 | 3ファイル想定 |
| 6 | テキスト分割 | <0.5秒 | 150チャンク想定 |
| 7 | **埋め込み生成** | **~25秒** | **最も時間がかかる** |
| 8 | ChromaDB保存 | <2秒 | バッチ保存 |
| 9 | Character初期化 | <0.1秒 | YAML読み込み |
| **合計** | **~30秒** | - |

### 1.3 2回目以降の起動

```
┌──────┐      ┌─────────────┐      ┌──────────┐      ┌──────────┐
│ User │      │   chat.py   │      │ RAGEngine│      │ChromaDB  │
└──┬───┘      └──────┬──────┘      └────┬─────┘      └────┬─────┘
   │                 │                   │                 │
   │ python chat.py  │                   │                 │
   │────────────────>│                   │                 │
   │                 │                   │                 │
   │                 │ RAGEngine.__init__()                │
   │                 │──────────────────>│                 │
   │                 │                   │ コレクション確認│
   │                 │                   │────────────────>│
   │                 │                   │<────────────────│
   │                 │                   │ count = 150     │
   │                 │                   │                 │
   │                 │<──────────────────│ 既存データ使用  │
   │<────────────────│ 準備完了 (5秒)   │                 │
```

**高速化のポイント**: 埋め込み生成をスキップ

---

## 2. 会話フロー（RAGあり）

### 2.1 基本シーケンス

```
┌──────┐  ┌─────────┐  ┌─────────┐  ┌──────────┐  ┌─────────┐
│ User │  │Character│  │RAGEngine│  │OllamaClient│  │Ollama   │
└──┬───┘  └────┬────┘  └────┬────┘  └─────┬─────┘  └────┬────┘
   │           │             │              │             │
   │ 入力      │             │              │             │
   │──────────>│             │              │             │
   │           │             │              │             │
   │           │ search()    │              │             │
   │           │────────────>│              │             │
   │           │             │ embed(query) │             │
   │           │             │─────────────>│             │
   │           │             │              │ 埋め込み生成│
   │           │             │              │────────────>│
   │           │             │              │<────────────│
   │           │             │<─────────────│ vector      │
   │           │             │              │             │
   │           │             │ ChromaDB検索 │             │
   │           │             │──┐           │             │
   │           │             │<─┘ 類似度計算│             │
   │           │             │              │             │
   │           │<────────────│ 検索結果     │             │
   │           │  top_k件    │              │             │
   │           │             │              │             │
   │           │ プロンプト構築              │             │
   │           │──┐          │              │             │
   │           │<─┘ system + context + history            │
   │           │             │              │             │
   │           │ generate()  │              │             │
   │           │─────────────┼─────────────>│             │
   │           │             │              │ テキスト生成│
   │           │             │              │────────────>│
   │           │             │              │<────────────│
   │           │<────────────┼──────────────│ 応答        │
   │           │             │              │             │
   │           │ 履歴更新    │              │             │
   │           │──┐          │              │             │
   │           │<─┘          │              │             │
   │<──────────│ 応答        │              │             │
```

### 2.2 処理時間内訳

| ステップ | 処理 | 所要時間 | 累計 |
|---------|------|---------|------|
| 1 | ユーザー入力受付 | - | - |
| 2 | クエリ埋め込み | ~0.1秒 | 0.1秒 |
| 3 | ChromaDB検索 | ~0.3秒 | 0.4秒 |
| 4 | プロンプト構築 | <0.1秒 | 0.5秒 |
| 5 | **LLM生成** | **~2.5秒** | **3.0秒** |
| 6 | 履歴更新 | <0.1秒 | 3.1秒 |
| **合計** | - | **~3秒** | - |

---

## 3. 会話フロー（Query Rewrite有効）

### 3.1 シーケンス

```
┌──────┐  ┌─────────┐  ┌──────────┐
│ User │  │Character│  │OllamaClient│
└──┬───┘  └────┬────┘  └─────┬─────┘
   │           │              │
   │ "それって│              │
   │  正確？" │              │
   │──────────>│              │
   │           │              │
   │           │ _rewrite_query()
   │           │──┐           │
   │           │  │ 履歴確認  │
   │           │<─┘           │
   │           │              │
   │           │ generate()   │
   │           │ (rewrite用)  │
   │           │─────────────>│
   │           │              │
   │           │<─────────────│
   │           │ "JetRacerの  │
   │           │  センサーの   │
   │           │  精度は？"   │
   │           │              │
   │           │ [通常のRAG検索へ]
```

### 3.2 Query Rewrite判断基準

```python
if rewrite_query and len(history) > 0:
    # 以下の場合に有効
    if contains_pronoun(user_input):  # "それ"、"あれ"
        rewrite = True
    elif is_vague(user_input):  # "詳しく"、"もっと"
        rewrite = True
    elif is_followup(user_input):  # "なぜ？"、"理由は？"
        rewrite = True
```

### 3.3 処理時間への影響

| モード | 所要時間 | 差分 |
|--------|---------|------|
| Query Rewrite OFF | ~3.0秒 | - |
| Query Rewrite ON | ~4.5秒 | +1.5秒 |

**トレードオフ**: 精度向上 vs 応答速度

---

## 4. エラーフロー

### 4.1 Ollama接続失敗

```
┌──────┐  ┌──────────┐  ┌─────────┐
│ User │  │OllamaClient│  │ Ollama  │
└──┬───┘  └─────┬─────┘  └────┬────┘
   │            │              │
   │ generate() │              │
   │───────────>│ generate()   │
   │            │─────────────>│
   │            │              │ ✗ 接続失敗
   │            │<─────────────│
   │            │ ConnectionError
   │            │              │
   │            │ リトライ(1/3)│
   │            │ wait 1秒     │
   │            │──┐           │
   │            │<─┘           │
   │            │ generate()   │
   │            │─────────────>│
   │            │              │ ✗ 失敗
   │            │<─────────────│
   │            │              │
   │            │ リトライ(2/3)│
   │            │ wait 2秒     │
   │            │──┐           │
   │            │<─┘           │
   │            │ generate()   │
   │            │─────────────>│
   │            │              │ ✓ 成功
   │            │<─────────────│
   │<───────────│ 応答         │
```

### 4.2 エラー種別と対応

| エラー | 検出場所 | 対応策 | リトライ |
|--------|---------|--------|---------|
| ConnectionError | OllamaClient | exponential backoff | 3回 |
| TimeoutError | OllamaClient | タイムアウト30秒 | 1回 |
| EmbeddingError | RAGEngine | エラーログ、RAG無効化 | なし |
| ModelNotFound | OllamaClient | エラーメッセージ表示 | なし |
| ChromaDBError | RAGEngine | エラーログ、続行 | なし |

---

## 5. 状態遷移

### 5.1 システム状態

```
          起動
            ↓
    ┌──────────────┐
    │ INITIALIZING │ 初期化中
    └──────┬───────┘
           │ 成功
           ↓
    ┌──────────────┐
    │    READY     │ 待機中
    └──────┬───────┘
           │ ユーザー入力
           ↓
    ┌──────────────┐
    │  PROCESSING  │ 処理中
    └──────┬───────┘
           │
           ├─ 成功 ──→ READY
           │
           └─ エラー ─→ ERROR
                         ↓
                      自動回復試行
                         ↓
                    ┌─────┴─────┐
                    │           │
                  成功        失敗
                    │           │
                    ↓           ↓
                  READY     TERMINATED
```

### 5.2 会話状態

```
           新規会話
              ↓
    ┌──────────────┐
    │ CONVERSATION │
    │   (turn=0)   │
    └──────┬───────┘
           │
           ↓
    ┌──────────────┐
    │   TURN N     │ ←─┐
    └──────┬───────┘    │
           │            │
           ├─ 継続 ─────┘
           │
           ├─ clear_history() ──→ CONVERSATION (turn=0)
           │
           └─ 終了 ──→ END
```

---

## 6. データの流れ

### 6.1 テキストデータの変換

```
1. 生テキスト（knowledge/*.txt）
   ↓ チャンク分割
2. テキストチャンク（1000文字）
   ↓ 埋め込み生成
3. ベクトル（mxbai-embed-large）
   ↓ ChromaDB保存
4. 永続化データ（data/chroma_db/）
   ↓ 検索時
5. 類似チャンク（top_k件）
   ↓ プロンプト統合
6. コンテキスト（システムプロンプトに注入）
```

### 6.2 会話履歴の流れ

```
1. ユーザー入力
   ↓
2. Character.history に追加
   {"role": "user", "content": "..."}
   ↓
3. LLMに送信（messages配列の一部）
   ↓
4. LLM応答
   ↓
5. Character.history に追加
   {"role": "assistant", "content": "..."}
   ↓ ターン経過
6. 最大10ターン保持
   ↓ 超過時
7. 古いものから削除（FIFO）
```

---

## 7. 並行処理（将来拡張）

### 7.1 現在の実装（同期処理）

```
ユーザー入力
    ↓
RAG検索（0.5秒）
    ↓
LLM生成（2.5秒）
    ↓
応答（合計3秒）
```

### 7.2 将来の改善案（非同期）

```
ユーザー入力
    ↓
    ├─→ RAG検索（0.5秒）────┐
    │                       ↓
    └─→ 前処理（0.3秒）─────┤ 並行処理
                           ↓
                    結果統合（0.1秒）
                           ↓
                    LLM生成（2.5秒）
                           ↓
                    応答（合計3.1秒）
```

**改善幅**: ~0.4秒短縮

---

## 8. メモリ使用量

### 8.1 メモリ配分

| コンポーネント | 使用量 | 備考 |
|--------------|--------|------|
| Ollama (LLM) | ~10GB VRAM | Gemma3-12B |
| ChromaDB | ~200MB RAM | 150チャンク |
| 会話履歴 | ~10KB RAM | 10ターン |
| Python本体 | ~100MB RAM | - |
| **合計** | **~10GB VRAM + 300MB RAM** | - |

### 8.2 ディスク使用量

| データ | 使用量 | 場所 |
|--------|--------|------|
| ChromaDB | ~100MB | data/chroma_db/ |
| ログファイル | ~10MB | logs/*.log |
| 設定ファイル | ~50KB | *.yaml, *.txt |
| **合計** | **~110MB** | - |

---

## 9. レイテンシ目標と実測

### 9.1 目標値

| 処理 | 目標 |
|------|------|
| 初回起動 | < 30秒 |
| 2回目起動 | < 5秒 |
| RAG検索 | < 0.5秒 |
| LLM生成 | < 3秒 |
| 全体応答 | < 4秒 |

### 9.2 ボトルネック

1. **初回起動**: 埋め込み生成（~25秒）
   - 改善案: 事前にChromaDB生成
   
2. **LLM生成**: Gemma3-12Bの推論（~2.5秒）
   - 改善案: GPU最適化、量子化

3. **RAG検索**: ChromaDB検索（~0.3秒）
   - 十分高速、改善不要

---

## 10. データフロー図（統合版）

```
┌─────────────────────────────────────────────────────────────┐
│                      起動フロー                              │
│                                                              │
│  config.yaml → OllamaClient → RAGEngine → Character         │
│                     ↓              ↓                         │
│                  Ollama      ChromaDB                        │
│                                ↓                             │
│                        knowledge/*.txt                       │
└─────────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────────┐
│                      会話フロー                              │
│                                                              │
│  User Input                                                  │
│      ↓                                                       │
│  Character.respond()                                         │
│      ↓                                                       │
│  [Optional] Query Rewrite                                    │
│      ↓                                                       │
│  RAGEngine.search() → OllamaClient.embed() → ChromaDB       │
│      ↓                                                       │
│  Context + History → System Prompt                           │
│      ↓                                                       │
│  OllamaClient.generate() → Ollama                           │
│      ↓                                                       │
│  Response → History Update → User                            │
└─────────────────────────────────────────────────────────────┘
```

---

**作成日**: 2026年1月14日  
**最終更新**: 2026年1月14日
