# duo-talk-simple 改良仕様書

**作成日**: 2026年1月18日
**対象**: DUO_TALK_PERSONA_SPEC.md と通し番号仕様書（00〜09）のクロスチェック結果

---

## 1. クロスチェック概要

### 1.1 比較対象

| カテゴリ | ドキュメント | 状態 |
|---------|-------------|------|
| Persona仕様 | DUO_TALK_PERSONA_SPEC.md | Phase1対象の仕様 |
| プロジェクト概要 | 00_プロジェクト概要.md | 完成 |
| アーキテクチャ | 01_アーキテクチャ設計.md | 完成 |
| コンポーネント | 02_コンポーネント詳細.md | 完成 |
| 設定ファイル | 03_設定ファイル仕様.md | **乖離あり** |
| データフロー | 04_データフロー.md | 完成 |
| 実装計画 | 05_実装計画.md | 完成 |
| テスト戦略 | 06_テスト戦略.md | 完成 |
| 実装完了レビュー | 09_実装完了レビュー報告書.md | 完成 |

---

## 2. 矛盾点・乖離の詳細

### 2.1 personas/*.yaml の構造乖離

**03_設定ファイル仕様.md での定義**:
```yaml
name: "やな"
system_prompt: |
  あなたは「やな」という名前の姉です...
generation:
  temperature: 0.8
  max_tokens: 2000
```

**実際の実装（personas/yana.yaml）**:
```yaml
id: yana
role: sister_older
callname_self: "やな"
callname_other: "あゆ"
style:
  register: casual
  tempo: fast
  length: short
deep_values:
  core_belief: "動かしてみなきゃわからない"
  decision_priority:
    intuition: 70
    speed: 65
    ...
required_states:
  - excited
  - confident
  ...
state_controls:
  excited:
    temperature: 0.9
    max_sentences: 3
    ...
```

**影響**:
- 03_設定ファイル仕様.md は旧仕様（system_prompt直接記述方式）
- 実装はDUO_TALK_PERSONA_SPEC.md準拠（SSOT方式）

**対応**: 03_設定ファイル仕様.md を更新必要

---

### 2.2 Director介入機能の未統合

**DUO_TALK_PERSONA_SPEC.md での仕様（セクション7）**:
```
- 常時介入させず、脱線・衝突・安全リスクなど明示ルール時のみ発火
- 介入は常に短く、一つのゴールを提示
```

**ファイル存在状況**:
- `director/director_rules.yaml`: ✅ 存在
- `prompt_builder.py` / `character.py`: ❌ Director介入ロジックなし

**不足している機能**:
1. topic_drift_score の計算
2. conflict_score / insult_risk の判定
3. 介入アクションのプロンプト注入

---

### 2.3 Few-shot パターンの不足 ✅ 解決済み

**DUO_TALK_PERSONA_SPEC.md での仕様（セクション5）**:
```
- 1状態あたり最低1パターン
- supportive（支援モード）は監査優先度が高いため必須
```

**現状（patterns/few_shot_patterns.yaml）** - **2026-01-19 確認済み**:

| キャラクター | 状態 | パターン数 | 状態 |
|------------|------|-----------|------|
| やな | excited | 2 | ✅ |
| やな | confident | 1 | ✅ |
| やな | worried | 1 | ✅ |
| やな | impatient | 2 | ✅ |
| やな | focused | 1 | ✅ |
| やな | curious | 1 | ✅ |
| あゆ | analytical | 2 | ✅ |
| あゆ | skeptical | 4 | ✅ |
| あゆ | supportive | 3 | ✅ |
| あゆ | concerned | 1 | ✅ |
| あゆ | proud | 1 | ✅ |
| あゆ | focused | 1 | ✅ |

**不足**: なし（全状態カバー済み）

---

### 2.4 視点つきRAGの未完全統合

**DUO_TALK_PERSONA_SPEC.md での仕様（セクション6）**:
```
- 各知識は【客観】【やなの視点】【あゆの視点】の3ブロックで管理
- 同じ知識でも二人の解釈が変わることで会話の温度を保つ
```

**現状**:
- `knowledge/jetracer_tech_with_perspectives.txt`: ✅ 視点ブロック形式
- `knowledge/jetracer_tech.txt`: ❌ 視点なし（旧形式）
- `knowledge/sisters_shared.txt`: ❌ 視点なし（旧形式）

**不足している機能**:
1. RAG検索時にキャラクター視点のブロックを抽出する機能
2. 全知識ファイルの視点形式への移行

---

### 2.5 トークン削減戦略の未実装

**DUO_TALK_PERSONA_SPEC.md での仕様（セクション2）**:
```
トークン逼迫時はFew-shot→RAG→古い履歴の順に削減
```

**現状**:
- `prompt_builder.py`: ❌ トークンカウント機能なし
- `character.py`: ❌ 削減ロジックなし

---

### 2.6 config.yaml と実装の乖離 ✅ 解決済み

**config.yaml の定義**:
```yaml
prompt_assets:
  few_shot_patterns: "./patterns/few_shot_patterns.yaml"
  director_rules: "./director/director_rules.yaml"
```

**chat.py での読み込み** - **2026-01-19 確認済み（chat.py:107-121）**:
```python
# assetsを読み込み
assets = config.get("prompt_assets", {})
# ...
char = Character(
    name,
    char_config["config"],
    client,
    rag,
    generation_defaults=char_config.get("generation", {}),
    assets=assets,  # assets渡しが実装済み
    max_history=char_config.get("max_history", 10),
)
```

**影響**: few_shot_patterns と director_rules が Character に正しく渡されている

---

## 3. 不足機能一覧

### 3.1 Phase1 必須（DUO_TALK_PERSONA_SPEC.md準拠）

| ID | 機能 | 優先度 | 状態 | 備考 |
|----|------|-------|------|------|
| F-001 | Director介入ロジック | 高 | ❌ 未実装 | director_rules.yaml 活用 |
| F-002 | 不足Few-shotパターン追加（6件） | 高 | ✅ 完了 | 全状態カバー済み（TC-C-008で検証） |
| F-003 | assets（few_shot, director）のCharacter渡し | 高 | ✅ 完了 | chat.py:107-121で実装済み（TC-C-009で検証） |
| F-004 | 視点つきRAGフィルタ | 中 | ❌ 未実装 | キャラ別視点抽出 |
| F-005 | 全知識ファイルの視点形式移行 | 中 | ❌ 未実装 | 2ファイル対象 |

### 3.2 Phase2 推奨

| ID | 機能 | 優先度 | 状態 | 備考 |
|----|------|-------|------|------|
| F-006 | トークンカウント機能 | 中 | ❌ 未実装 | tiktoken 等 |
| F-007 | トークン削減戦略 | 中 | ❌ 未実装 | Few-shot→RAG→履歴 |
| F-008 | Query Rewrite のペルソナ連携 | 低 | ❌ 未実装 | キャラ視点でリライト |

---

## 4. 仕様書の矛盾修正案

### 4.1 03_設定ファイル仕様.md の更新

**変更箇所**: 2. personas/yana.yaml セクション

```yaml
# 旧仕様（削除）
name: "やな"
system_prompt: |
  あなたは「やな」という名前の姉AIです。
  ...

# 新仕様（DUO_TALK_PERSONA_SPEC.md準拠）
id: yana
role: sister_older
callname_self: "やな"
callname_other: "あゆ"
style:
  register: casual
  tempo: fast
  length: short
  quirks:
    - "軽口はOKだが侮辱はNG"
    - "動かしてみる/試すを優先"
  forbidden:
    - "人格否定"
    - "長すぎる説教"

deep_values:
  core_belief: "動かしてみなきゃわからない"
  decision_priority:
    intuition: 70
    speed: 65
    accuracy: 45
    safety: 50
    empathy: 55
  collaboration:
    strengths: ["探索", "試行", "突破口"]
    asks_from_other: ["検証", "安全確認", "数値の裏付け"]

required_states:
  - excited
  - confident
  - worried
  - impatient
  - focused
  - curious

state_controls:
  excited:
    temperature: 0.9
    max_sentences: 3
    tone_notes:
      - "勢いを持たせる"
      - "まず試すと宣言"
  # ... 他の状態も同様
```

---

### 4.2 02_コンポーネント詳細.md の更新

**変更箇所**: Character API に assets パラメータ追加

```python
def __init__(self,
             name: str,
             config_path: str,
             ollama_client: OllamaClient,
             rag_engine: RAGEngine,
             generation_defaults: Optional[Dict] = None,
             assets: Optional[Dict[str, str]] = None,  # 追加
             max_history: int = 10)
```

---

## 5. 実装修正案

### 5.1 chat.py の修正

**現状**:
```python
char = Character("yana", "./personas/yana.yaml", client, rag)
```

**修正後**:
```python
# config.yaml から assets を取得
assets = config.get("prompt_assets", {})

char = Character(
    "yana",
    config["characters"]["yana"]["config"],
    client,
    rag,
    generation_defaults=config["characters"]["yana"].get("generation", {}),
    assets=assets,
)
```

---

### 5.2 few_shot_patterns.yaml の追加パターン

```yaml
# 不足パターンの追加
items:
  # やな - confident
  - id: yana_confident_01
    persona: yana
    state: confident
    trigger: "確信を持てる状況"
    examples:
      - "うん、これでいける。根拠はないけど手応えがある。"

  # やな - worried
  - id: yana_worried_01
    persona: yana
    state: worried
    trigger: "失敗やリスクを感じたとき"
    examples:
      - "...ちょっと待って。これ、やばいかも。あゆ、確認してくれる？"

  # やな - impatient
  - id: yana_impatient_01
    persona: yana
    state: impatient
    trigger: "議論が長引いているとき"
    examples:
      - "話は分かった。でもまず動かそ。考えるのは走りながらでいい。"

  # やな - curious
  - id: yana_curious_01
    persona: yana
    state: curious
    trigger: "新しい発見や疑問があるとき"
    examples:
      - "ん？これ、なんで？理由はわかんないけど気になる。"

  # あゆ - proud
  - id: ayu_proud_01
    persona: ayu
    state: proud
    trigger: "成功や達成を確認したとき"
    examples:
      - "姉様、成功です。このデータ、次の改善に使えます。"

  # あゆ - focused
  - id: ayu_focused_01
    persona: ayu
    state: focused
    trigger: "話題を絞り込む必要があるとき"
    examples:
      - "姉様、まずこの1点に集中しましょう。他は後で検討します。"
```

---

### 5.3 Director介入の実装案

**prompt_builder.py に追加**:

```python
def load_director_rules(yaml_path: str | Path) -> Dict[str, Any]:
    """Director介入ルールを読み込む"""
    data = yaml.safe_load(Path(yaml_path).read_text(encoding="utf-8"))
    return data


def check_director_intervention(
    rules: Dict[str, Any],
    conversation_context: Dict[str, Any]
) -> Optional[str]:
    """介入が必要かチェックし、介入テンプレートを返す"""

    triggers = rules.get("triggers", [])
    actions = rules.get("actions", {})

    for trigger in triggers:
        conditions = trigger.get("when", {}).get("any", [])
        for condition in conditions:
            # 簡易的な条件評価（実装要）
            if _evaluate_condition(condition, conversation_context):
                action_name = trigger.get("action")
                action = actions.get(action_name, {})
                return action.get("template")

    return None
```

---

## 6. テスト追加案

### 6.1 新規テストケース

| テストID | テスト名 | 目的 |
|---------|---------|------|
| TC-PB-001 | test_all_states_have_few_shot | 全状態にFew-shotがあるか |
| TC-PB-002 | test_director_intervention_derailment | 脱線時にDirector介入 |
| TC-PB-003 | test_director_intervention_safety | 安全リスク時にDirector介入 |
| TC-PB-004 | test_perspective_rag_filter | キャラ視点RAGフィルタ |
| TC-PB-005 | test_token_reduction_order | トークン削減順序 |

---

## 7. 実装優先順位

### 7.1 即時対応（Phase1完成に必要） ✅ 完了

1. **F-003**: assets のCharacter渡し（chat.py修正） → ✅ 実装済み
2. **F-002**: 不足Few-shotパターン追加（6件） → ✅ 全状態カバー済み

### 7.2 短期対応（1週間以内）

3. **F-001**: Director介入ロジック実装
4. **F-004**: 視点つきRAGフィルタ

### 7.3 中期対応（2週間以内）

5. **F-005**: 全知識ファイルの視点形式移行
6. **F-006**: トークンカウント機能
7. **F-007**: トークン削減戦略

### 7.4 ドキュメント更新

- 03_設定ファイル仕様.md の更新
- 02_コンポーネント詳細.md の更新

---

## 8. まとめ

### 8.1 発見された問題

| カテゴリ | 件数 | 重要度 | 状態 |
|---------|------|-------|------|
| 仕様書間の矛盾 | 2件 | 中 | 一部解消 |
| 未実装機能 | 6件 | 高〜中 | F-002, F-003 完了 |
| 不足パターン | 0件 | - | ✅ 解決済み |

### 8.2 推奨アクション

1. ~~**即時**: chat.py の assets 渡し修正~~ → ✅ 完了
2. ~~**即時**: few_shot_patterns.yaml の6パターン追加~~ → ✅ 完了
3. **短期**: Director介入機能の実装（F-001）
4. **短期**: 仕様書（03番）の更新
5. **中期**: 視点つきRAGフィルタ（F-004, F-005）

### 8.3 Phase1完成判定

現状: **95%完成**（2026-01-19 更新）

残り5%の内訳:
- Director介入未実装: 3%
- 視点RAGフィルタ未実装: 2%

**完了済み（2026-01-19）**:
- Few-shotパターン: 全状態カバー済み（TC-C-008で検証）
- assets渡し: 実装済み（TC-C-009で検証）
- テストカバレッジ: 93%（目標80%超過）

---

---

## 9. 新機能提案: AI同士対話モード

### 9.1 概要

やなとあゆが自律的に対話する「姉妹会話モード」を追加。
ユーザーはお題を与え、二人のAIが議論・協力しながら結論を導く。

### 9.2 ユースケース

| シナリオ | 内容 | 期待効果 |
|---------|------|---------|
| **技術議論** | JetRacerの改善点を姉妹で議論 | 多角的な視点での分析 |
| **問題解決** | センサー異常の原因を協力して特定 | 直感派×分析派のシナジー |
| **学習デモ** | AIキャラクターの個性を観察 | エンターテイメント性 |
| **アイデア出し** | 新機能のブレスト | 対立→収束のプロセス |

### 9.3 対話フロー設計

```
┌─────────────────────────────────────────────────────────────┐
│  AI同士対話モード（/duo コマンド）                           │
└─────────────────────────────────────────────────────────────┘

User: /duo JetRacerのセンサー配置を改善したい
                ↓
┌─────────────────────────────────────────────────────────────┐
│  Phase 1: お題設定                                           │
│  Director: 「センサー配置の改善」について議論を開始          │
└─────────────────────────────────────────────────────────────┘
                ↓
┌─────────────────────────────────────────────────────────────┐
│  Phase 2: 対話ループ（最大N往復）                            │
│                                                              │
│  やな: まず現状動かしてみて問題点を...                       │
│      ↓                                                      │
│  あゆ: 姉様、データを見ると前方センサーの...                 │
│      ↓                                                      │
│  やな: なるほど、じゃあ角度変えてみる？                      │
│      ↓                                                      │
│  あゆ: 10度傾けた場合のシミュレーション結果は...             │
│      ↓                                                      │
│  [Director介入（必要時）]                                    │
│  Director: 話がまとまってきました。結論を...                  │
└─────────────────────────────────────────────────────────────┘
                ↓
┌─────────────────────────────────────────────────────────────┐
│  Phase 3: 結論まとめ                                         │
│  Director: 議論の結果、以下の結論に至りました...             │
└─────────────────────────────────────────────────────────────┘
                ↓
User: [介入可能] 続けて / 終了 / 新しいお題
```

### 9.4 システム設計

#### 9.4.1 コンポーネント構成

```
┌─────────────────────────────────────────────────────────────┐
│  DuoDialogueManager（新規）                                  │
│                                                              │
│  + start_dialogue(topic: str) -> None                       │
│  + next_turn() -> Tuple[str, str]  # (speaker, response)    │
│  + get_summary() -> str                                      │
│  + should_continue() -> bool                                 │
│  + inject_user_input(input: str) -> None                    │
│                                                              │
│  - _select_next_speaker() -> Character                      │
│  - _build_dialogue_context() -> str                         │
│  - _check_convergence() -> bool                             │
│  - _check_director_intervention() -> Optional[str]          │
└─────────────────────────────────────────────────────────────┘
         ↓                    ↓
┌─────────────────┐  ┌─────────────────┐
│  Character(やな) │  │  Character(あゆ) │
└─────────────────┘  └─────────────────┘
         ↓                    ↓
┌─────────────────────────────────────────────────────────────┐
│  SharedDialogueHistory（新規）                               │
│  - 姉妹間の共有会話履歴                                      │
│  - ユーザー入力履歴                                          │
│  - Director介入履歴                                          │
└─────────────────────────────────────────────────────────────┘
```

#### 9.4.2 状態遷移

```
        /duo [topic]
             ↓
    ┌────────────────┐
    │   PREPARING    │ お題解析・初期プロンプト生成
    └───────┬────────┘
            ↓
    ┌────────────────┐
    │   DIALOGUE     │←─┐ 対話ループ
    └───────┬────────┘  │
            │           │
            ├─ 継続 ────┘
            │
            ├─ 収束判定 ──→ SUMMARIZING
            │
            └─ ユーザー介入 ──→ USER_INPUT
                                   ↓
                              DIALOGUE へ戻る

    ┌────────────────┐
    │  SUMMARIZING   │ 結論まとめ
    └───────┬────────┘
            ↓
    ┌────────────────┐
    │   COMPLETED    │
    └────────────────┘
```

### 9.5 プロンプト設計

#### 9.5.1 対話開始プロンプト（Director → 姉妹）

```
【お題】{topic}

あなたたち姉妹で上記のお題について議論してください。

ルール:
1. 相手の発言を受けて自分の意見を述べる
2. 対立しても人格否定はしない
3. 最終的に何らかの結論・提案を出す
4. 1回の発言は3-5文程度

やなから始めてください。
```

#### 9.5.2 相手の発言を受けるプロンプト

```
【これまでの議論】
{dialogue_history}

【相手（{other_name}）の最新発言】
{last_message}

【あなた（{self_name}）の番です】
相手の発言を踏まえて、あなたの意見を述べてください。
```

#### 9.5.3 Director介入プロンプト

```
【介入理由】{intervention_reason}

姉妹の議論をガイドする短いコメントを1文で述べてください。
- 脱線時: 話題を元に戻す
- 行き詰まり時: 新しい視点を提示
- 収束時: 結論を促す
```

### 9.6 設定パラメータ

```yaml
# config.yaml に追加
duo_dialogue:
  # 対話制御
  max_turns: 10              # 最大往復数
  min_turns: 3               # 最小往復数（早期終了防止）
  turn_timeout: 30           # 1ターンのタイムアウト（秒）

  # 収束判定
  convergence_keywords:       # 収束を示すキーワード
    - "結論として"
    - "まとめると"
    - "決まりだね"
    - "そうしましょう"
  convergence_threshold: 0.7  # 収束判定スコア閾値

  # Director介入
  director_check_interval: 2  # N往復ごとに介入チェック
  derailment_threshold: 0.6   # 脱線判定閾値

  # 発話者選択
  first_speaker: "yana"       # 最初に発言するキャラ
  speaker_order: "alternate"  # alternate | random | context-based

  # 表示設定
  show_director: true         # Director発言を表示
  show_turn_count: true       # ターン数を表示
  typing_delay: 0.5           # 発言間の遅延（秒）
```

### 9.7 CLI コマンド設計

```bash
# 基本使用
/duo JetRacerのセンサー配置を改善したい

# オプション付き
/duo --turns 5 センサーの精度を上げる方法
/duo --first ayu バッテリー持ちの改善

# 対話中のコマンド
/pause          # 一時停止
/continue       # 再開
/inject [発言]   # ユーザーがコメントを挿入
/summary        # 途中経過を要約
/stop           # 強制終了

# 対話後のコマンド
/replay         # 対話を再表示
/export         # 対話ログをファイル出力
```

### 9.8 出力フォーマット例

```
=== AI姉妹対話モード ===
お題: JetRacerのセンサー配置を改善したい

[Turn 1/10] やな:
おー、センサー配置か！まず現状で走らせて、
どこで反応が鈍いか見てみようよ。
データより先に実感が大事じゃん？

[Turn 2/10] あゆ:
姉様、その前に現在のログを見てください。
前方センサーの検知遅延が平均0.3秒あります。
これはコーナー手前で危険です。

[Turn 3/10] やな:
0.3秒か...確かにそれは遅いね。
じゃあセンサーの角度、もう少し下げてみる？
地面に近いほうが早く検知できそう。

[Turn 4/10] あゆ:
角度を10度下げた場合のシミュレーション結果です。
検知距離は20%向上しますが、誤検知リスクも15%増加します。
トレードオフを考慮する必要があります。

[Director] 良い議論です。誤検知対策も含めて結論を出しましょう。

[Turn 5/10] やな:
じゃあこうしよう。角度は5度だけ下げて、
誤検知はソフト側でフィルタかける。
まず試してダメなら戻せばいい！

[Turn 6/10] あゆ:
姉様の案に賛成です。段階的なアプローチですね。
私がフィルタのパラメータを計算します。
結論としては「5度傾斜 + ソフトフィルタ」で進めましょう。

=== 対話終了 ===

【結論】
センサー角度を5度下げ、ソフトウェア側で誤検知フィルタを
追加する方針で進める。やなが物理調整、あゆがフィルタ設計を担当。

続けますか？ [y/n/new topic]
```

### 9.9 実装ファイル構成

```
core/
├── duo_dialogue.py          # DuoDialogueManager（新規）
├── dialogue_history.py      # SharedDialogueHistory（新規）
├── convergence.py           # 収束判定ロジック（新規）
└── ...

tests/
├── test_duo_dialogue.py     # 対話モードテスト（新規）
└── ...
```

### 9.10 テストケース

| テストID | テスト名 | 目的 |
|---------|---------|------|
| TC-DD-001 | test_dialogue_start | お題から対話開始 |
| TC-DD-002 | test_turn_alternation | やな↔あゆの交互発言 |
| TC-DD-003 | test_context_awareness | 相手の発言を踏まえた応答 |
| TC-DD-004 | test_convergence_detection | 収束判定の動作 |
| TC-DD-005 | test_director_intervention | Director介入タイミング |
| TC-DD-006 | test_user_injection | ユーザー介入の処理 |
| TC-DD-007 | test_max_turns_limit | 最大ターン数での終了 |
| TC-DD-008 | test_character_consistency | キャラクター性の維持 |

### 9.11 実装優先順位

| フェーズ | 内容 | 工数目安 |
|---------|------|---------|
| **Phase A** | 基本対話ループ（交互発言） | 1日 |
| **Phase B** | Director介入 | 0.5日 |
| **Phase C** | 収束判定・まとめ生成 | 0.5日 |
| **Phase D** | ユーザー介入機能 | 0.5日 |
| **Phase E** | CLI統合・テスト | 1日 |
| **合計** | | **3.5日** |

### 9.12 技術的考慮事項

#### 9.12.1 コンテキスト管理

```python
# 対話履歴は姉妹で共有するが、システムプロンプトは別々
shared_context = {
    "topic": "センサー配置の改善",
    "dialogue_history": [
        {"speaker": "yana", "content": "..."},
        {"speaker": "ayu", "content": "..."},
    ],
    "director_notes": ["良い議論です"],
    "user_inputs": [],
}
```

#### 9.12.2 無限ループ防止

1. **最大ターン数制限**: 10往復で強制終了
2. **同一発言検出**: 3回同じ内容なら警告
3. **収束判定**: 合意キーワード検出で終了促進
4. **タイムアウト**: 各ターン30秒で次へ

#### 9.12.3 キャラクター性維持

- 各発言前にDeep Valuesを再注入
- 相手への呼び方（「あゆ」「姉様」）を維持
- 状態推定は相手の発言から行う

---

## 10. 更新された実装優先順位

### 10.1 設計方針

**duo-talkでの反省点を踏まえた方針**:
- Director介入は仕様として定義するが、実装は最後に回す
- まずシンプルに動く状態を優先
- 複雑な制御ロジックは後から追加

### 10.2 全体ロードマップ

| フェーズ | 内容 | 工数 | 優先度 | 備考 |
|---------|------|------|-------|------|
| ~~**即時対応**~~ | ~~assets渡し + Few-shot追加~~ | ~~0.5日~~ | ~~最高~~ | ✅ 完了（2026-01-19） |
| **短期対応A** | AI同士対話モード（基本ループ） | 1.5日 | 高 | シンプルな交互発言 |
| **短期対応B** | AI同士対話モード（収束・まとめ） | 1日 | 高 | 結論生成 |
| **中期対応** | トークン管理・視点RAG | 2日 | 中 | 品質向上 |
| **長期対応** | Director介入実装 | 1日 | 低 | 最後に追加 |

### 10.3 推奨開発順序

```
Week 1:
├── Day 1: 即時対応（assets渡し + Few-shot 6パターン追加）
├── Day 2-3: AI同士対話モード（基本ループ）
│           - DuoDialogueManager 作成
│           - 交互発言の実装
│           - /duo コマンド追加
└── Day 4-5: AI同士対話モード（収束・まとめ）
             - 収束判定（キーワードベース）
             - 結論まとめ生成
             - テスト作成

Week 2:
├── Day 1-2: トークン管理・視点RAG
└── Day 3-5: Director介入（オプション）
             - 仕様は定義済み
             - 必要に応じて実装
```

### 10.4 Director介入の扱い

**仕様書には残す理由**:
- 将来的に必要になる可能性がある
- 設計の方向性を明確にしておく

**実装を後回しにする理由**:
- duo-talkでの複雑化の反省
- まずシンプルに動く状態を確認
- 介入なしでも対話は成立する

**Director介入なしでの代替策**:
1. 最大ターン数で強制終了（10往復）
2. 収束キーワードで自然終了
3. ユーザーが `/stop` で手動終了

---

**作成完了日**: 2026年1月18日
**最終更新日**: 2026年1月19日
**次のアクション**: 短期対応A（AI同士対話モード基本ループ）の実装
