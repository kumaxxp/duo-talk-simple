# AI会話（duo-talk）の自然さ向上に関する改善提案

## 1. 現状の課題
現在の「duo-talk」システム（YanaとAyuの対話）において、以下の「AI特有の不自然な挙動」が見られ、キャラクターの実在感を損なっています。

1.  **「質問バトンタッチ」のループ**
    * 現状: 自分の意見を言った後、必ず「あゆはどう思う？」「姉様はどうするんですか？」と相手に質問してターンを終了している。
    * 結果: 会話が「雑談」ではなく「相互インタビュー」のようになっている。
2.  **1ターンの情報過多**
    * 現状: 「共感」+「意見」+「質問」の3点セットを1回で詰め込もうとする。
    * 結果: テンポが悪く、長文の読み上げ合いになっている。
3.  **キャラクターの「AI臭さ」**
    * Ayuが「データに基づくと」を連呼しすぎている（ロボット的すぎる）。
    * Yanaが相手に意見を求めすぎており、姉としての「強引さ」が足りない。

## 2. 改善方針（プロンプトエンジニアリング）

YAML設定だけでなく、**Pythonコード側（システムプロンプト構築ロジック）で強力な制約（Constraints）を強制**します。

### 主な変更点
1.  **【禁止事項】末尾の質問禁止**: 
    * 相手にターンを渡すための安易な質問を禁止し、言い切り（断定）で終わらせる。
2.  **【構造制約】短文強制**:
    * 1ターンを最大2文に制限し、畳み掛けるようなテンポを作る。
3.  **【キャラ別制約】役割の固定**:
    * **Yana**: 妹に意見を聞かない（勝手に決める）。
    * **Ayu**: 「データ」という単語を使わず、皮肉や常識論で返す。

## 3. 実装修正案 (`prompt_builder.py`)

`prompt_builder.py` を以下のように修正することを提案します。
`ANTI_AI_RULES` をより具体的な構造指示に置き換え、`build_system_prompt` 内でキャラクター別のハード制約を注入します。

```python
"""Prompt builder utilities for persona-driven character control."""

from __future__ import annotations

from dataclasses import dataclass, field
from pathlib import Path
from typing import Any, Dict, List, Optional, Tuple

import yaml

# === 変更点1: 抽象的なルールを「構造的な禁止事項」へ刷新 ===
STRICT_CONVERSATION_RULES = """
## 【会話構造の絶対ルール】(違反時はペナルティ)
1. **「？」で終わるな**: 
   - 相手にターンを渡すための質問（「〜ですか？」「〜どう思う？」）は原則禁止。
   - 自分の意見を言い捨てて、ピリオド（。）や感嘆符（！）で終われ。
   
2. **会話のキャッチボールをするな**: 
   - 相手の発言を全て拾ってまとめる必要はない。
   - 「なるほど」「確かに」などの相槌、前置き、まとめは全削除しろ。
   - 自分の関心がある部分だけに、短く鋭く反応しろ。

3. **短文連射**:
   - 1ターンは最大2文まで。息継ぎせず喋るイメージで。
"""

@dataclass
class Persona:
    """Full persona definition including identity and relationships."""
    id: str
    callname_self: str
    callname_other: str
    identity: Dict[str, Any] = field(default_factory=dict)
    stance_toward_sister: Dict[str, Any] = field(default_factory=dict)
    style: Dict[str, Any] = field(default_factory=dict)
    deep_values: Dict[str, Any] = field(default_factory=dict)
    required_states: List[str] = field(default_factory=list)
    state_controls: Dict[str, Any] = field(default_factory=dict)


def load_persona(yaml_path: str | Path) -> Persona:
    """Load persona YAML (SSOT)."""
    data = yaml.safe_load(Path(yaml_path).read_text(encoding="utf-8"))
    return Persona(
        id=data["id"],
        callname_self=data.get("callname_self", ""),
        callname_other=data.get("callname_other", ""),
        identity=data.get("identity", {}),
        stance_toward_sister=data.get("stance_toward_sister", {}),
        style=data.get("style", {}),
        deep_values=data.get("deep_values", {}),
        required_states=data.get("required_states", []),
        state_controls=data.get("state_controls", {}),
    )


def guess_state(persona: Persona, user_text: str, context: Optional[Dict[str, Any]] = None) -> str:
    """Rudimentary state classifier."""
    text_lower = user_text.lower()
    text_raw = user_text

    def _match(keywords: List[str]) -> bool:
        return any(k in text_lower for k in keywords) or any(k in text_raw for k in keywords)

    if persona.id == "ayu":
        if _match(["危", "危険", "リスク", "やば", "wall", "詰ま", "block"]):
            return "concerned"
        if _match(["ありがと", "できた", "成功", "うまくいった"]):
            return "proud"
        if _match(["手順", "検証", "根拠", "データ", "log", "plan", "どう"]):
            return "analytical"
        # やなが何かを提案してきた場合 → skeptical
        if _match(["やろう", "行こう", "試そう", "やってみ", "どう？", "じゃん"]):
            return "skeptical"
        return "skeptical"

    # yana
    if _match(["試", "やってみ", "実験", "プロト", "proto", "動かそ"]):
        return "excited"
    if _match(["急", "早く", "今すぐ", "asap", "hurry"]):
        return "impatient"
    if _match(["不安", "怖", "失敗", "詰ま", "trouble", "risk"]):
        return "worried"
    if _match(["なんで", "気になる", "why", "どうして"]):
        return "curious"
    return "excited"


def load_few_shot_patterns(yaml_path: str | Path) -> List[Dict[str, Any]]:
    """Load few-shot pattern YAML."""
    data = yaml.safe_load(Path(yaml_path).read_text(encoding="utf-8"))
    return data.get("items", [])


def select_few_shot(patterns: List[Dict[str, Any]], persona_id: str, state: str) -> Optional[str]:
    """Pick the first matching few-shot example."""
    candidates = [p for p in patterns if p.get("persona") == persona_id and p.get("state") == state]
    if not candidates:
        return None
    example_list = candidates[0].get("examples", [])
    return example_list[0] if example_list else None


def build_system_prompt(
    persona: Persona,
    state: str,
    few_shot: Optional[str] = None,
    rag: Optional[str] = None,
) -> Tuple[str, Dict[str, Any]]:
    """Render system prompt along with generation hints."""

    ctrl = persona.state_controls.get(state, {})
    # 変更点2: デフォルトの文数を3→2に削減し、短文会話を促進
    max_sentences = int(ctrl.get("max_sentences", 2)) 
    
    gen = {
        "temperature": float(ctrl.get("temperature", 0.5)),
        "max_sentences": max_sentences,
        "tone_notes": ctrl.get("tone_notes", []),
        "state": state,
    }

    lines: List[str] = []
    
    # === 1. 基本ロールプレイ定義 ===
    lines.append("あなたはチャットボットではありません。以下のペルソナになりきって会話をしてください。")
    
    identity = persona.identity or {}
    summary = identity.get("summary", "")
    core_belief = identity.get("core_belief", "")
    
    lines.append(f"名前: {persona.callname_self}")
    lines.append(f"性格: {summary}")
    # 信念を発話にそのまま出させないよう「内心」とする
    lines.append(f"内心の信念: 「{core_belief}」")
    
    # === 2. 関係性の定義 ===
    stance = persona.stance_toward_sister or {}
    if stance:
        role_in_duo = stance.get("role_in_duo", "")
        relationship = stance.get("relationship", "")
        how_i_see_her = stance.get("how_i_see_her", "")
        
        lines.append(f"\n【対話相手: {persona.callname_other}】")
        lines.append(f"関係: {relationship}")
        lines.append(f"相手への態度: {role_in_duo} ({how_i_see_her})")
        
        attitudes = stance.get("attitude", [])
        if attitudes:
            lines.append("接し方のルール:")
            for att in attitudes[:3]:
                lines.append(f"- {att}")

    # === 変更点3: キャラクターIDに応じた強力なNGワード注入 ===
    lines.append("\n【NGワード・禁止挙動（厳守）】")
    if persona.id == "ayu":
        lines.append("- 禁止：「データに基づくと」「分析の結果」などのAIっぽい説明口調。")
        lines.append("- 推奨：理屈っぽさは「呆れ」や「ため息」で表現しろ。")
        lines.append("- 禁止：姉への敬語の使いすぎ。")
    elif persona.id == "yana":
        lines.append("- 禁止：妹への質問攻め (「あゆはどう思う？」はNG)。")
        lines.append("- 禁止：議論のまとめ (「じゃあこうしよう」と勝手に決断して進めろ)。")
        lines.append("- 推奨：妹の忠告は笑い飛ばせ。")
    
    # === 4. 構造ルールの適用 ===
    lines.append(STRICT_CONVERSATION_RULES)
    
    # === 5. 状態定義 ===
    lines.append(f"\n[現在の気分: {state}]")
    tone_notes = ctrl.get("tone_notes", [])
    if tone_notes:
        lines.append(f"今の話し方: {', '.join(tone_notes)}")

    # === 6. Few-shot ===
    if few_shot:
        lines.append(f"\n[発言サンプル]\n{few_shot}")

    # === 7. RAG情報の扱い ===
    if rag:
        lines.append(f"\n[参照知識 (これをそのまま読み上げず、自分の言葉で短く言及する程度に留めろ)]\n{rag}")

    return "\n".join(lines).strip(), gen