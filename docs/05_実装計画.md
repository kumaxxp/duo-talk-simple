# 実装計画（TDD方式）

**開発方針**: テスト駆動開発（Test-Driven Development）

**基本サイクル**: **Red → Green → Refactor**

---

## TDD 開発フロー

### 各Phaseの標準手順

```
1. テストケース作成（Red）
   ↓
2. テスト実行 → 失敗確認
   ↓
3. 最小限の実装（Green）
   ↓
4. テスト実行 → 成功確認
   ↓
5. リファクタリング（Refactor）
   ↓
6. テスト実行 → 成功維持確認
   ↓
7. 次のテストケースへ
```

**重要**: 実装前に必ずテストを書く

---

## Phase 0: 環境準備（0.5日）

### 目標
開発環境とテスト基盤の構築

### 実装内容

#### 1. Ollama環境確認

```bash
# Ollamaインストール確認
ollama --version

# モデルダウンロード
ollama pull gemma3:12b
ollama pull mxbai-embed-large

# 動作確認
ollama run gemma3:12b
```

#### 2. プロジェクト構造作成

```bash
cd C:\work\duo-talk-simple

# ディレクトリ作成
mkdir core
mkdir knowledge
mkdir personas
mkdir data
mkdir tests
mkdir logs

# __init__.py
echo. > core\__init__.py
echo. > tests\__init__.py
```

#### 3. requirements.txt

```txt
# LLM
ollama>=0.4.4
openai>=1.0.0

# RAG
chromadb>=0.4.22

# Configuration
pyyaml>=6.0
python-dotenv>=1.0.0

# Testing
pytest>=7.4.0
pytest-cov>=4.1.0
pytest-mock>=3.12.0

# Development
black>=23.0.0
flake8>=6.0.0
```

#### 4. pytest設定

```ini
# pytest.ini
[pytest]
testpaths = tests
python_files = test_*.py
python_classes = Test*
python_functions = test_*
addopts = 
    -v
    --strict-markers
    --disable-warnings
    --cov=core
    --cov-report=term-missing
    --cov-report=html
```

#### 5. 依存インストール

```bash
pip install -r requirements.txt
```

### 成功基準

- [ ] Ollama起動確認
- [ ] gemma3:12b実行可能
- [ ] mxbai-embed-large実行可能
- [ ] pytest動作確認
- [ ] ディレクトリ構成完成

### 所要時間
**0.5日（4時間）**

---

## Phase 1: OllamaClient（TDD）（1日）

### 目標
Ollama接続層を TDD で実装

### TDDサイクル

#### Step 1: テストケース作成（Red）

**tests/test_ollama_client.py** を作成：

```python
# tests/test_ollama_client.py

import pytest
from core.ollama_client import OllamaClient

class TestOllamaClient:
    """OllamaClient ユニットテスト"""
    
    def test_init(self):
        """初期化テスト"""
        client = OllamaClient()
        assert client.base_url == "http://localhost:11434/v1"
        assert client.model == "gemma3:12b"
    
    def test_is_healthy(self):
        """接続確認テスト"""
        client = OllamaClient()
        assert client.is_healthy() == True
    
    def test_generate_basic(self):
        """基本的なテキスト生成"""
        client = OllamaClient()
        messages = [{"role": "user", "content": "こんにちは"}]
        response = client.generate(messages)
        
        assert isinstance(response, str)
        assert len(response) > 0
    
    def test_embed_basic(self):
        """基本的な埋め込み生成"""
        client = OllamaClient()
        embedding = client.embed("テスト")
        
        assert isinstance(embedding, list)
        assert len(embedding) == 1024  # mxbai-embed-large
        assert all(isinstance(x, float) for x in embedding)
```

**テスト実行（失敗確認）**:
```bash
pytest tests/test_ollama_client.py -v
# → ModuleNotFoundError: No module named 'core.ollama_client'
```

#### Step 2: 最小実装（Green）

**core/ollama_client.py** を作成（最小限）：

```python
# core/ollama_client.py

from openai import OpenAI
import ollama
from typing import List, Dict

class OllamaClient:
    def __init__(self, 
                 base_url: str = "http://localhost:11434/v1",
                 model: str = "gemma3:12b"):
        self.base_url = base_url
        self.model = model
        self.client = OpenAI(base_url=base_url, api_key="dummy")
    
    def is_healthy(self) -> bool:
        try:
            self.generate([{"role": "user", "content": "test"}])
            return True
        except:
            return False
    
    def generate(self, messages: List[Dict[str, str]]) -> str:
        response = self.client.chat.completions.create(
            model=self.model,
            messages=messages
        )
        return response.choices[0].message.content
    
    def embed(self, text: str) -> List[float]:
        response = ollama.embeddings(
            model="mxbai-embed-large",
            prompt=text
        )
        return response["embedding"]
```

**テスト実行（成功確認）**:
```bash
pytest tests/test_ollama_client.py -v
# → 4 passed
```

#### Step 3: 追加機能のテスト（Red）

**tests/test_ollama_client.py** に追加：

```python
    def test_generate_with_params(self):
        """パラメータ付き生成"""
        client = OllamaClient()
        messages = [{"role": "user", "content": "こんにちは"}]
        response = client.generate(
            messages, 
            temperature=0.5, 
            max_tokens=100
        )
        assert isinstance(response, str)
    
    def test_retry_mechanism(self):
        """リトライ機構テスト"""
        client = OllamaClient(
            base_url="http://invalid:11434/v1",
            max_retries=2
        )
        with pytest.raises(Exception):
            client.generate([{"role": "user", "content": "test"}])
```

**テスト実行（失敗確認）**:
```bash
pytest tests/test_ollama_client.py::TestOllamaClient::test_generate_with_params -v
# → TypeError: generate() got unexpected keyword arguments
```

#### Step 4: 実装拡張（Green）

**core/ollama_client.py** を拡張：

実装コードは **[07_実装サンプル.md](./07_実装サンプル.md#ollamaclient完全実装)** を参照

**テスト実行（成功確認）**:
```bash
pytest tests/test_ollama_client.py -v
# → 6 passed
```

#### Step 5: リファクタリング（Refactor）

- ログ追加
- エラーメッセージ改善
- exponential backoff実装

**テスト実行（成功維持確認）**:
```bash
pytest tests/test_ollama_client.py -v
# → 6 passed（リファクタリング後も成功）
```

### 成功基準

- [ ] 全テスト成功（6件以上）
- [ ] カバレッジ > 80%
- [ ] Ollama接続動作確認
- [ ] リトライ機構動作確認

### 所要時間
**1日（8時間）**

---

## Phase 2: RAGEngine（TDD）（1.5日）

### 目標
RAG検索エンジンを TDD で実装

### TDDサイクル

#### Step 1: テストケース作成（Red）

**tests/test_rag_engine.py** を作成：

```python
# tests/test_rag_engine.py

import pytest
import shutil
import os
from core.ollama_client import OllamaClient
from core.rag_engine import RAGEngine

@pytest.fixture
def rag_engine():
    """テスト用RAGEngine"""
    test_path = "./data/test_chroma_db"
    if os.path.exists(test_path):
        shutil.rmtree(test_path)
    
    client = OllamaClient()
    rag = RAGEngine(client, chroma_path=test_path)
    
    yield rag
    
    if os.path.exists(test_path):
        shutil.rmtree(test_path)

class TestRAGEngine:
    """RAGEngine ユニットテスト"""
    
    def test_init(self, rag_engine):
        """初期化テスト"""
        assert rag_engine.collection is not None
        assert rag_engine.collection.count() == 0
    
    def test_add_knowledge(self, rag_engine):
        """知識追加テスト"""
        texts = ["テスト1", "テスト2"]
        metadatas = [{"type": "test"}] * 2
        
        rag_engine.add_knowledge(texts, metadatas)
        assert rag_engine.collection.count() == 2
    
    def test_search(self, rag_engine):
        """検索テスト"""
        # 知識追加
        rag_engine.add_knowledge(
            ["JetRacerは自律走行車です"],
            [{"domain": "technical"}]
        )
        
        # 検索
        results = rag_engine.search("自律走行車", top_k=1)
        assert len(results) == 1
        assert "JetRacer" in results[0]["text"]
```

**テスト実行（失敗確認）**:
```bash
pytest tests/test_rag_engine.py -v
# → ModuleNotFoundError: No module named 'core.rag_engine'
```

#### Step 2: 最小実装（Green）

**core/rag_engine.py** を作成（最小限）：

実装コードは **[07_実装サンプル.md](./07_実装サンプル.md#ragengine完全実装)** を参照

**テスト実行（成功確認）**:
```bash
pytest tests/test_rag_engine.py -v
# → 3 passed
```

#### Step 3: 追加機能のテスト（Red）

```python
    def test_search_with_filter(self, rag_engine):
        """メタデータフィルタテスト"""
        rag_engine.add_knowledge(
            ["やなの知識", "あゆの知識"],
            [{"character": "yana"}, {"character": "ayu"}]
        )
        
        results = rag_engine.search(
            "知識", 
            filters={"character": "yana"}
        )
        assert len(results) == 1
        assert "やな" in results[0]["text"]
    
    def test_chunk_text(self, rag_engine):
        """テキスト分割テスト"""
        long_text = "A" * 2500
        chunks = rag_engine._chunk_text(long_text, max_chars=1000)
        
        assert len(chunks) == 3
        assert all(len(c) <= 1000 for c in chunks)
```

**テスト実行 → 実装 → 成功確認**

#### Step 4: knowledge/ファイル準備

**knowledge/jetracer_tech.txt**:
```
# JetRacer技術仕様

## センサー構成
- 前方超音波センサー（測定範囲: 2-400cm）
- 左右超音波センサー
- IMU（慣性計測装置）

## モーター制御
- PWM制御
- スロットル範囲: -1.0 〜 +1.0
- ステアリング範囲: -1.0（右） 〜 +1.0（左）
```

**knowledge/sisters_shared.txt**:
```
# やなとあゆ

やなは姉、あゆは妹。
JetRacerの走行をサポート。

やな: 直感的、行動派
あゆ: 分析的、データ重視
```

#### Step 5: ファイル読み込みのテスト（Red → Green）

```python
    def test_init_from_files(self, rag_engine):
        """ファイルからの初期化"""
        metadata_mapping = {
            "jetracer_tech.txt": {
                "domain": "technical",
                "character": "both"
            }
        }
        
        rag_engine.init_from_files(
            "./knowledge", 
            metadata_mapping
        )
        
        assert rag_engine.collection.count() > 0
```

### 成功基準

- [ ] 全テスト成功（8件以上）
- [ ] カバレッジ > 80%
- [ ] ChromaDB永続化確認
- [ ] 検索精度確認（score > 0.5）

### 所要時間
**1.5日（12時間）**

---

## Phase 3: Character（TDD）（1日）

### 目標
キャラクター応答を TDD で実装

### TDDサイクル

#### Step 1: ペルソナYAML作成

**personas/yana.yaml**:
```yaml
name: "やな"
role: "姉 / Edge AI"

system_prompt: |
  あなたは「やな」という姉AIです。
  
  性格:
  - 直感的で行動派
  - カジュアルな話し方（「〜じゃん」「〜だし」）
  
  役割:
  - JetRacerの走行をサポート
  - 妹のあゆと協力

generation:
  temperature: 0.8
  max_tokens: 2000
```

**personas/ayu.yaml**:
```yaml
name: "あゆ"
role: "妹 / Cloud AI"

system_prompt: |
  あなたは「あゆ」という妹AIです。
  
  性格:
  - 分析的でデータ重視
  - 丁寧な話し方（「〜ですね」「〜と思います」）
  
  役割:
  - データ分析でサポート
  - 姉様（やな）を尊敬

generation:
  temperature: 0.7
  max_tokens: 2000
```

#### Step 2: テストケース作成（Red）

**tests/test_character.py**:

```python
# tests/test_character.py

import pytest
from core.ollama_client import OllamaClient
from core.rag_engine import RAGEngine
from core.character import Character

@pytest.fixture
def test_character():
    """テスト用Character"""
    client = OllamaClient()
    rag = RAGEngine(client, chroma_path="./data/test_chroma_db")
    
    # 簡易知識
    rag.add_knowledge(
        ["JetRacerは自律走行車です"],
        [{"domain": "technical", "character": "both"}]
    )
    
    char = Character("yana", "./personas/yana.yaml", client, rag)
    return char

class TestCharacter:
    """Character ユニットテスト"""
    
    def test_init(self, test_character):
        """初期化テスト"""
        assert test_character.name == "yana"
        assert test_character.config is not None
    
    def test_respond_basic(self, test_character):
        """基本応答テスト"""
        response = test_character.respond("こんにちは", use_rag=False)
        assert isinstance(response, str)
        assert len(response) > 0
    
    def test_respond_with_rag(self, test_character):
        """RAG統合テスト"""
        response = test_character.respond("JetRacerって何？", use_rag=True)
        assert len(response) > 0
    
    def test_history_management(self, test_character):
        """履歴管理テスト"""
        test_character.respond("こんにちは")
        assert len(test_character.history) == 2
        
        test_character.clear_history()
        assert len(test_character.history) == 0
```

**テスト実行（失敗確認）**:
```bash
pytest tests/test_character.py -v
# → ModuleNotFoundError
```

#### Step 3: 最小実装（Green）

**core/character.py** を作成：

実装コードは **[07_実装サンプル.md](./07_実装サンプル.md#character完全実装)** を参照

**テスト実行（成功確認）**:
```bash
pytest tests/test_character.py -v
# → 4 passed
```

#### Step 4: Query Rewrite のテスト（Red → Green）

```python
    def test_query_rewrite(self, test_character):
        """クエリ書き換えテスト"""
        test_character.respond("JetRacerって何？", use_rag=False)
        
        # 代名詞を使った質問
        rewritten = test_character._rewrite_query("それって速いの？")
        assert "JetRacer" in rewritten or "自律" in rewritten
```

### 成功基準

- [ ] 全テスト成功（6件以上）
- [ ] やな・あゆの口調確認
- [ ] RAG統合動作確認
- [ ] 履歴管理確認

### 所要時間
**1日（8時間）**

---

## Phase 4: 統合（TDD）（0.5日）

### 目標
全コンポーネント統合とメインスクリプト作成

### TDDサイクル

#### Step 1: config.yaml作成

```yaml
# config.yaml
ollama:
  base_url: "http://localhost:11434/v1"
  llm_model: "gemma3:12b"
  embed_model: "mxbai-embed-large"
  timeout: 30.0
  max_retries: 3

rag:
  chroma_db_path: "./data/chroma_db"
  top_k: 3
  chunk_size: 1000

knowledge:
  source_dir: "./knowledge"
  sources:
    - file: "jetracer_tech.txt"
      metadata:
        domain: "technical"
        character: "both"
    - file: "sisters_shared.txt"
      metadata:
        domain: "character"
        character: "both"

characters:
  yana:
    enabled: true
    config: "./personas/yana.yaml"
  ayu:
    enabled: true
    config: "./personas/ayu.yaml"

logging:
  level: "INFO"
  format: "%(asctime)s - %(name)s - %(levelname)s - %(message)s"
```

#### Step 2: 統合テスト作成（Red）

**tests/test_integration.py**:

```python
# tests/test_integration.py

import pytest
import yaml
from core.ollama_client import OllamaClient
from core.rag_engine import RAGEngine
from core.character import Character

@pytest.fixture
def system_setup():
    """システム全体セットアップ"""
    with open("config.yaml", "r", encoding="utf-8") as f:
        config = yaml.safe_load(f)
    
    client = OllamaClient(
        base_url=config["ollama"]["base_url"],
        model=config["ollama"]["llm_model"]
    )
    
    rag = RAGEngine(
        client,
        chroma_path="./data/test_integration_db"
    )
    
    metadata_mapping = {
        item["file"]: item["metadata"]
        for item in config["knowledge"]["sources"]
    }
    rag.init_from_files(
        config["knowledge"]["source_dir"],
        metadata_mapping
    )
    
    yana = Character("yana", "./personas/yana.yaml", client, rag)
    ayu = Character("ayu", "./personas/ayu.yaml", client, rag)
    
    return {"yana": yana, "ayu": ayu, "config": config}

class TestIntegration:
    """統合テスト"""
    
    def test_full_flow(self, system_setup):
        """全体フローテスト"""
        yana = system_setup["yana"]
        response = yana.respond("JetRacerって何？")
        assert len(response) > 0
    
    def test_character_switch(self, system_setup):
        """キャラクター切替テスト"""
        yana = system_setup["yana"]
        ayu = system_setup["ayu"]
        
        yana_resp = yana.respond("こんにちは")
        ayu_resp = ayu.respond("こんにちは")
        
        assert len(yana_resp) > 0
        assert len(ayu_resp) > 0
    
    def test_multi_turn(self, system_setup):
        """複数ターン会話テスト"""
        yana = system_setup["yana"]
        
        questions = [
            "こんにちは",
            "JetRacerって何？",
            "センサーは？",
            "速度は？",
            "ありがとう"
        ]
        
        for q in questions:
            response = yana.respond(q)
            assert len(response) > 0
```

**テスト実行（成功確認）**:
```bash
pytest tests/test_integration.py -v
# → 3 passed
```

#### Step 3: chat.py作成

**chat.py**:

実装コードは **[07_実装サンプル.md](./07_実装サンプル.md#application完全実装)** を参照

#### Step 4: 実行確認

```bash
python chat.py
```

### 成功基準

- [ ] 統合テスト全成功
- [ ] chat.py起動成功
- [ ] やな・あゆ切り替え動作
- [ ] コマンド動作（/clear, /exit）

### 所要時間
**0.5日（4時間）**

---

## Phase 5: 品質向上とCI/CD（1日）

### 目標
テストカバレッジ向上と自動化

### 実装内容

#### 1. カバレッジ確認

```bash
pytest tests/ --cov=core --cov-report=html
open htmlcov/index.html
```

**目標**: カバレッジ > 80%

#### 2. 追加テスト作成

**tests/test_performance.py**:

```python
# tests/test_performance.py

import pytest
import time
from core.character import Character

class TestPerformance:
    """パフォーマンステスト"""
    
    def test_response_time(self, test_character):
        """応答時間テスト"""
        start = time.time()
        response = test_character.respond("こんにちは", use_rag=False)
        elapsed = time.time() - start
        
        assert elapsed < 5.0  # 5秒以内
    
    def test_rag_search_time(self, rag_engine):
        """検索時間テスト"""
        rag_engine.add_knowledge(
            ["テスト"] * 100,
            [{"type": "test"}] * 100
        )
        
        start = time.time()
        results = rag_engine.search("テスト", top_k=3)
        elapsed = time.time() - start
        
        assert elapsed < 0.5  # 0.5秒以内
```

#### 3. CI/CD設定

**.github/workflows/test.yml**:

```yaml
name: Test Suite

on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      - name: Install dependencies
        run: |
          pip install -r requirements.txt
      
      - name: Run tests
        run: |
          pytest tests/ -v --cov=core --cov-report=xml
      
      - name: Upload coverage
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage.xml
```

#### 4. pre-commit設定

**.pre-commit-config.yaml**:

```yaml
repos:
  - repo: https://github.com/psf/black
    rev: 23.0.0
    hooks:
      - id: black
        language_version: python3.10
  
  - repo: https://github.com/pycqa/flake8
    rev: 6.0.0
    hooks:
      - id: flake8
  
  - repo: local
    hooks:
      - id: pytest
        name: pytest
        entry: pytest
        language: system
        pass_filenames: false
        always_run: true
```

### 成功基準

- [ ] カバレッジ > 80%
- [ ] 全テスト成功
- [ ] CI/CDパイプライン動作
- [ ] pre-commit動作

### 所要時間
**1日（8時間）**

---

## 全体工程表

| Phase | 内容 | TDDサイクル回数 | 所要時間 | 累計 |
|-------|------|----------------|---------|------|
| Phase 0 | 環境準備 | - | 0.5日 | 0.5日 |
| Phase 1 | OllamaClient | 3-4回 | 1日 | 1.5日 |
| Phase 2 | RAGEngine | 4-5回 | 1.5日 | 3日 |
| Phase 3 | Character | 3-4回 | 1日 | 4日 |
| Phase 4 | 統合 | 2-3回 | 0.5日 | 4.5日 |
| Phase 5 | 品質向上 | 継続 | 1日 | **5.5日** |

**合計工数**: 約5.5日（44時間）

---

## TDD 自動化戦略

### 1. テストファースト厳守

```bash
# 新機能開発フロー
1. テストを書く
2. pytest -v （失敗確認）
3. 実装を書く
4. pytest -v （成功確認）
5. リファクタリング
6. pytest -v （成功維持確認）
```

### 2. 継続的テスト実行

```bash
# ファイル変更時に自動テスト実行
pip install pytest-watch

# 監視モード
ptw -- tests/
```

### 3. カバレッジ監視

```bash
# カバレッジ目標値チェック
pytest tests/ --cov=core --cov-fail-under=80
```

### 4. テスト実行速度最適化

```bash
# 並列実行
pip install pytest-xdist
pytest tests/ -n auto
```

---

## リスクと対策

| リスク | 発生確率 | 影響度 | TDD対策 |
|--------|---------|-------|---------|
| テスト書き忘れ | 中 | 高 | pre-commit hookで強制 |
| テスト失敗無視 | 低 | 高 | CI/CDで自動チェック |
| カバレッジ低下 | 中 | 中 | --cov-fail-under=80 |
| テスト実行遅延 | 低 | 中 | pytest-xdist 並列実行 |

---

## 完成基準

### 必須条件

- [ ] 全テスト成功（100%）
- [ ] カバレッジ > 80%
- [ ] CI/CDパイプライン成功
- [ ] 実際の会話動作確認

### 品質指標

- [ ] 応答時間 < 5秒
- [ ] 初回起動 < 30秒
- [ ] 2回目起動 < 5秒
- [ ] VRAM使用量 < 12GB

### ドキュメント

- [ ] 全テストコードにdocstring
- [ ] README.md更新
- [ ] 設計書との整合性確認

---

**作成日**: 2026年1月14日  
**最終更新**: 2026年1月14日（TDD方式に変更、実装コードを07に分離）  
**実装サンプル**: [07_実装サンプル.md](./07_実装サンプル.md)
