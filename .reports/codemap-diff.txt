# Codemap Update Diff Report

Generated: 2026-01-20
Previous Version: Phase 2B (perspective markers)
Current Version: Phase 5 (Director/NoveltyGuard integration)

## Summary

| Metric | Before | After | Change |
|--------|--------|-------|--------|
| Core modules | 6 | 9 | +50% |
| Total lines (core/) | ~1376 | 2427 | +76% |
| Test files | 10 | 12 | +20% |
| Total tests | 108 | 206 | +91% |
| Coverage | 94% | 91% | -3% |

## New Files Added

| File | Lines | Purpose |
|------|-------|---------|
| core/types.py | 41 | Shared type definitions (DirectorStatus, DirectorEvaluation, LoopCheckResult) |
| core/director.py | 605 | Quality evaluation with static checks and LLM scoring |
| core/novelty_guard.py | 272 | Loop detection and escape strategy injection |
| tests/test_director.py | ~400 | Director unit tests (53 tests) |
| tests/test_novelty_guard.py | ~300 | NoveltyGuard unit tests (27 tests) |

## Modified Files

| File | Before | After | Change |
|------|--------|-------|--------|
| core/duo_dialogue.py | 330 | 462 | +40% |

### duo_dialogue.py Changes
- Added Director integration
- Added NoveltyGuard integration
- New method: next_turn_with_quality_check()
- New method: get_quality_report()
- Config support for director/novelty_guard settings

## Updated Codemaps

### docs/codemaps/core.md
- Module Index: Added 3 new modules
- New sections: core/types.py, core/director.py, core/novelty_guard.py
- Updated duo_dialogue.py section with quality control integration
- Updated Cross-Module Dependencies diagram
- Updated State Management table

### docs/codemaps/architecture.md
- System Overview: Added Quality Control box
- Dependency Graph: Added director/novelty_guard dependencies
- Module Responsibilities: Added 3 new modules
- Test Coverage Map: Updated test counts (206 tests)

### docs/codemaps/data.md
- Added DirectorStatus enum
- Added DirectorEvaluation dataclass
- Added LoopCheckResult dataclass
- Added LoopBreakStrategy enum
- Updated config.yaml schema with director/novelty_guard settings

### CLAUDE.md
- Updated test count: 108 → 206
- Updated coverage: 94% → 91%
- Added Director, NoveltyGuard, Types to components table
- New section: 品質評価システム（Phase 5）
- Updated テスト構造 section with new test files
- Updated config.yaml sections

## Diff Percentage

| Codemap | Lines Changed | Total Lines | Diff % |
|---------|---------------|-------------|--------|
| core.md | +200 | 378 | 53% |
| architecture.md | +50 | 192 | 26% |
| data.md | +60 | 322 | 19% |
| CLAUDE.md | +40 | 275 | 15% |

**Overall Change: ~35%** (significant update due to Phase 5 quality control integration)

## Verification Checklist

- [x] Module Index updated with line counts
- [x] New classes documented (Director, NoveltyGuard, types)
- [x] Cross-module dependencies updated
- [x] Test coverage map updated
- [x] Config schema documented
- [x] Freshness timestamps updated

## Notes

- Phase 5 represents the final integration phase of the quality evaluation migration
- Coverage decreased slightly (94%→91%) due to new modules, but remains above 90% target
- All new code follows existing patterns and conventions
